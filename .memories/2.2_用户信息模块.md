# 2.2 用户信息模块 - 开发记录

> 完成时间：2025-12-29

## 一、功能概述

实现用户资料管理，包括完善校友信息、头像上传、查看他人主页、用户注销等功能。

## 二、API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/users/profile/` | GET | 获取当前用户资料 |
| `/api/v1/users/profile/` | PUT | 更新当前用户资料 |
| `/api/v1/users/profile/avatar/` | POST | 上传头像 |
| `/api/v1/users/{id}/` | GET | 查看他人主页 |
| `/api/v1/users/deactivate/` | POST | 用户注销 |

## 三、文件清单

### 后端
- `backend/apps/users/models.py` - 添加 UserProfile 模型
- `backend/apps/users/serializers.py` - 添加资料序列化器
- `backend/apps/users/views.py` - 添加资料视图
- `backend/apps/users/urls.py` - 添加资料路由
- `backend/config/urls.py` - 注册 /api/v1/users/ 路由

## 四、数据模型

### UserProfile 模型（与 User 一对一）

| 字段 | 类型 | 说明 |
|------|------|------|
| user | OneToOneField | 关联用户 |
| real_name | CharField(50) | 真实姓名 |
| avatar | ImageField | 头像 |
| bio | TextField(500) | 个人简介 |
| school | ForeignKey | 学校 |
| enrollment_year | IntegerField | 入学年份 |
| graduation_year | IntegerField | 毕业年份 |
| class_name | CharField(50) | 班级 |
| is_profile_complete | BooleanField | 是否已完善 |

## 五、关键逻辑

### 资料完善判断（serializers.py:113-126）

```python
# 检查必填字段是否都已填写 / Check required fields
if all([
    instance.real_name,
    instance.school,
    instance.enrollment_year,
    instance.graduation_year,
    instance.class_name
]):
    instance.is_profile_complete = True
```

### 头像上传验证（views.py:187-202）

- 文件大小：≤ 5MB
- 文件类型：jpg/png/gif
- 存储路径：`media/avatars/年/月/`

### 用户注销（views.py:254-280）

```python
# 软删除 + 数据脱敏 / Soft delete + anonymization
user.is_active = False
user.username = f"已注销用户_{user.id}"
user.phone = None
```

## 六、注意事项

1. UserProfile 使用 `get_or_create` 自动创建
2. **隐私控制待 4.1 阶段实现**（需判断好友/同圈关系）
3. 头像存储依赖 Pillow 库
4. 注销后账号禁用，数据脱敏但保留记录
5. **响应格式使用 `common.response` 的 `success_response` / `error_response`**
