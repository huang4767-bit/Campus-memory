# 优化建议

> 记录各模块的技术优化项，后续根据需要排期实现

---

## 1.3 认证系统

### Token 刷新并发优化

**问题**：多个请求同时 401 时，会触发多次 refresh 请求

**影响**：资源浪费，可能导致 Token 混乱

**优化时机**：用户量增加或页面并发请求变多时

**优化方案**：

```javascript
// frontend/src/services/request.js

let isRefreshing = false;      // 是否正在刷新
let refreshSubscribers = [];   // 等待队列

// 添加到等待队列
function subscribeTokenRefresh(callback) {
  refreshSubscribers.push(callback);
}

// 刷新完成，通知所有等待的请求
function onRefreshed(newToken) {
  refreshSubscribers.forEach(callback => callback(newToken));
  refreshSubscribers = [];
}

// 响应拦截器中
if (error.response?.status === 401 && !originalRequest._retry) {
  if (isRefreshing) {
    // 正在刷新，加入等待队列
    return new Promise(resolve => {
      subscribeTokenRefresh(token => {
        originalRequest.headers.Authorization = `Bearer ${token}`;
        resolve(request(originalRequest));
      });
    });
  }

  originalRequest._retry = true;
  isRefreshing = true;

  try {
    const res = await axios.post('/api/v1/auth/refresh/', { refresh });
    const { access } = res.data;
    localStorage.setItem('access_token', access);
    onRefreshed(access);  // 通知等待的请求
    return request(originalRequest);
  } finally {
    isRefreshing = false;
  }
}
```

---

## 待添加

后续模块的优化建议将记录在此。
