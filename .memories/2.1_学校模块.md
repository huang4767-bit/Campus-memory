# 2.1 学校模块 - 开发记录

> 完成时间：2025-12-29

## 一、功能概述

实现学校数据管理，支持用户搜索、添加学校（无需审核），为后续用户完善校友信息提供数据支持。

## 二、API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/schools/` | GET | 学校列表（支持搜索、筛选） |
| `/api/v1/schools/` | POST | 添加学校 |
| `/api/v1/schools/{id}/` | GET | 学校详情 |

### 请求/响应示例

**搜索学校**
```
GET /api/v1/schools/?search=一中&province=北京市&city=北京市
```

**添加学校**
```json
// 请求
{
  "name": "北京市第一中学",
  "province": "北京市",
  "city": "北京市",
  "district": "东城区",
  "school_type": "senior"
}

// 响应
{"code": 201, "message": "添加成功", "data": {...}}
```

## 三、文件清单

### 后端
- `backend/apps/schools/models.py` - School 模型
- `backend/apps/schools/serializers.py` - 序列化器
- `backend/apps/schools/views.py` - 视图
- `backend/apps/schools/urls.py` - 路由

### 前端
- `frontend/src/utils/region.js` - 省市区数据工具函数
- 依赖包：`china-division`（省市区数据）

## 四、数据模型

### School 模型

| 字段 | 类型 | 说明 |
|------|------|------|
| name | CharField(100) | 学校名称 |
| province | CharField(50) | 省份 |
| city | CharField(50) | 城市 |
| district | CharField(50) | 区县（可选） |
| school_type | CharField(20) | 类型：junior/senior/combined |
| created_by | ForeignKey | 创建者 |
| created_at | DateTime | 创建时间 |

**约束**：name + province + city 联合唯一

### class Meta 配置（models.py:70-80）

```python
class Meta:
    db_table = 'schools'           # 数据库表名
    verbose_name = '学校'          # Admin 显示名称
    unique_together = ['name', 'province', 'city']  # 联合唯一
    indexes = [                    # 索引优化搜索
        models.Index(fields=['name']),
        models.Index(fields=['province', 'city']),
    ]
```

## 五、关键逻辑

### 学校去重（serializers.py:44-51）

```python
def validate(self, attrs):
    if School.objects.filter(
        name=name, province=province, city=city
    ).exists():
        raise ValidationError({'name': '该学校已存在'})
    return attrs
```

### 省市区级联（region.js）

```javascript
// 获取省份
getProvinces()

// 根据省份名获取城市
getCitiesByProvinceName('北京市')

// 根据省市名获取区县
getAreasByCityName('北京市', '北京市')
```

## 六、注意事项

1. 学校一旦创建不可修改（避免影响已关联用户）
2. 省市区数据使用 `china-division` 包，前端级联选择
3. 搜索使用 `icontains` 模糊匹配，已添加数据库索引优化
4. **分页使用 `common.pagination.StandardPagination`**（默认20，最大100）
5. **响应格式使用 `common.response` 的 `success_response` / `error_response`**
