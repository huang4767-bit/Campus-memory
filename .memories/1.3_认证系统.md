# 1.3 认证系统 - 开发记录

> 完成时间：2025-12-29

## 一、功能概述

实现用户注册、登录、Token 刷新功能，包含登录失败锁定机制（5次失败锁定15分钟）。

## 二、API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/auth/register/` | POST | 用户注册 |
| `/api/v1/auth/login/` | POST | 用户登录 |
| `/api/v1/auth/refresh/` | POST | Token 刷新 |

### 请求/响应示例

**注册**
```json
// 请求
{"username": "testuser", "password": "123456", "confirm_password": "123456"}

// 响应
{"code": 201, "message": "注册成功", "data": {"id": 1, "username": "testuser", ...}}
```

**登录**
```json
// 请求
{"username": "testuser", "password": "123456"}

// 响应
{"code": 200, "message": "登录成功", "data": {"access": "...", "refresh": "...", "user": {...}}}
```

## 三、文件清单

### 后端
- `backend/apps/users/models.py` - User 模型
- `backend/apps/users/serializers.py` - 序列化器
- `backend/apps/users/views.py` - 视图
- `backend/apps/users/urls.py` - 路由
- `backend/config/settings.py` - 添加 AUTH_USER_MODEL 配置

### 前端
- `frontend/src/pages/Login/index.jsx` - 登录页面
- `frontend/src/pages/Register/index.jsx` - 注册页面
- `frontend/src/services/request.js` - Token 自动刷新逻辑

## 四、数据模型

### User 模型（继承 AbstractUser）

| 字段 | 类型 | 说明 |
|------|------|------|
| phone | CharField(11) | 手机号（可选） |
| login_fail_count | IntegerField | 登录失败次数 |
| locked_until | DateTimeField | 锁定截止时间 |

> 注：2.2 阶段将创建独立的 UserProfile 模型存储校友信息

## 五、关键逻辑

### 登录失败锁定（views.py:86-105）

```
密码错误 → login_fail_count + 1 → 达到5次 → locked_until = now + 15分钟
登录成功 → login_fail_count = 0, locked_until = None
```

**并发优化**：使用 `F()` 表达式实现原子操作
```python
from django.db.models import F

# 避免并发计数不准
User.objects.filter(pk=user.pk).update(login_fail_count=F('login_fail_count') + 1)
user.refresh_from_db()
```

### Token 自动刷新（request.js:38-64）

```
请求返回 401 → 用 refresh_token 换新 access_token → 重试原请求
刷新失败 → 清除 token → 跳转登录页
```

## 六、配置项

### JWT 配置（settings.py）
- Access Token 有效期：2小时
- Refresh Token 有效期：7天

### 锁定配置（views.py）
- MAX_LOGIN_ATTEMPTS = 5
- LOCK_DURATION_MINUTES = 15

## 七、注意事项

1. `authenticate()` vs `check_password()`：为实现锁定逻辑，使用后者
2. SimpleJWT 的 refresh 接口直接返回 `{access: "..."}`，非统一格式
3. 前端字段 `confirmPassword` 需转换为后端的 `confirm_password`
